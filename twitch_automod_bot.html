<script>
    // Function to extract the access token from URL fragment
    function getTwitchToken() {
        const hash = window.location.hash;
        if (hash.includes("access_token")) {
            const params = new URLSearchParams(hash.substring(1));
            const accessToken = params.get("access_token");
    
            if (accessToken) {
                localStorage.setItem("twitch_token", accessToken);  // Store token for later use
                alert("Twitch Access Token Retrieved Successfully!");
                // Once token is retrieved, initialize the bot
                initializeBot(accessToken);
            } else {
                alert("Failed to retrieve Twitch token.");
            }
        }
    }
    
    // Function to initialize the bot after token is retrieved
    function initializeBot(token) {
        const client = new tmi.Client({
            options: {
                debug: true,
                skipMembership: true,
                skipUpdatingEmotesets: true,
            },
            connection: {
                reconnect: true,
                secure: true
            },
            identity: {
                username: 'Jiroshima_',  // Your bot's username
                password: `oauth:${token}`  // Use the retrieved OAuth token here
            },
            channels: ['Jiroshima_']  // Channel to join
        });
    
        // Connect to Twitch chat
        client.connect().then(() => {
            console.log("Connected to Twitch chat!");
        }).catch((error) => {
            console.error("Connection failed:", error);
        });
    
        const chatContainer = document.getElementById('chat-container');
    
        client.on('message', (channel, tags, message, self) => {
            console.log(`Message received from ${tags.username}: ${message}`);
    
            if (self) return;  // Ignore messages from the bot itself
    
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
    
            // Check if the message is a command like /ban or /timeout
            if (message.startsWith('/ban') || message.startsWith('/timeout')) {
                handleModerationCommand(channel, tags, message);
            } else {
                // Regular chat message handling
                messageDiv.innerHTML = `<strong>${tags.username}:</strong> ${message}`;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });
    }
    
    // Function to handle /ban and /timeout commands
    function handleModerationCommand(channel, tags, message) {
        const commandParts = message.split(' ');
        const command = commandParts[0].toLowerCase();
        const targetUsername = commandParts[1];  // Username to target
        let duration = 0;
    
        // Check if the command is /timeout, and if a duration is provided
        if (command === '/timeout' && commandParts[2]) {
            duration = parseInt(commandParts[2], 10);  // Timeout duration in seconds
            if (isNaN(duration)) {
                return;  // Invalid duration
            }
        }
    
        // Ensure the user has proper permissions (for simplicity, only allow the broadcaster or moderators)
        if (tags.mod || tags.username === 'Jiroshima_') {
            if (command === '/ban') {
                banUser(channel, targetUsername, "Banned by bot command");
            } else if (command === '/timeout') {
                timeoutUser(channel, targetUsername, duration);
            }
        } else {
            alert("You don't have permission to issue this command.");
        }
    }
    
    // Timeout user via Twitch Helix API
    function timeoutUser(channel, username, duration) {
        fetch(`https://api.twitch.tv/helix/moderation/automod/timeout`, {
            method: 'POST',
            headers: {
                'Client-ID': 'h29p7xsyql5d0bi8svypmjt3yqhl8z',
                'Authorization': `Bearer ${localStorage.getItem('twitch_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                broadcaster_id: 'YOUR_BROADCASTER_ID',  // Replace with actual broadcaster ID
                user_id: 'USER_ID_OF_' + username,  // Replace with actual user ID
                duration: duration * 60  // Duration in seconds
            })
        }).then(response => {
            if (response.ok) {
                console.log(`User ${username} timed out for ${duration} seconds`);
            } else {
                console.error("Failed to timeout user:", response);
            }
        }).catch(error => {
            console.error("Error timing out user:", error);
        });
    }
    
    // Ban user via Twitch Helix API
    function banUser(channel, username, reason) {
        fetch(`https://api.twitch.tv/helix/moderation/bans`, {
            method: 'POST',
            headers: {
                'Client-ID': 'h29p7xsyql5d0bi8svypmjt3yqhl8z',
                'Authorization': `Bearer ${localStorage.getItem('twitch_token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                broadcaster_id: 'YOUR_BROADCASTER_ID',  // Replace with actual broadcaster ID
                user_id: 'USER_ID_OF_' + username,  // Replace with actual user ID
                reason: reason
            })
        }).then(response => {
            if (response.ok) {
                console.log(`User ${username} banned for reason: ${reason}`);
            } else {
                console.error("Failed to ban user:", response);
            }
        }).catch(error => {
            console.error("Error banning user:", error);
        });
    }
    
    // Run the function when the page loads to retrieve the token
    window.onload = getTwitchToken;
    </script>
    