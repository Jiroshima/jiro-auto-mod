<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Chat Bot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chat-container {
            width: 80%;
            height: 500px;
            overflow-y: scroll;
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }

        .filtered {
            color: red;
        }
    </style>
</head>

<body>
    <h1>Welcome to the Twitch Bot Chat</h1>

    <!-- Authorization link to get the access token -->
    <a href="https://id.twitch.tv/oauth2/authorize?client_id=h29p7xsyql5d0bi8svypmjt3yqhl8z&redirect_uri=https://jiro-auto-mod.netlify.app/twitch_automod_bot.html&response_type=token&scope=chat%3Aedit+chat%3Aread+moderation%3Aread+moderation%3Amanage">Connect with Twitch</a>

    <div id="chat-container"></div>

    <script src="https://github.com/tmijs/tmi.js/releases/download/v1.8.5/tmi.min.js"></script>

    <script>
        // Function to extract the access token from URL fragment
        function getTwitchToken() {
            const hash = window.location.hash;
            if (hash.includes("access_token")) {
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get("access_token");

                if (accessToken) {
                    localStorage.setItem("twitch_token", accessToken);  // Store token for later use
                    alert("Twitch Access Token Retrieved Successfully!");
                    // Once token is retrieved, initialize the bot
                    initializeBot(accessToken);
                } else {
                    alert("Failed to retrieve Twitch token.");
                }
            }
        }

        // Function to initialize the bot after token is retrieved
        function initializeBot(token) {
            const client = new tmi.Client({
                options: {
                    debug: true,
                    skipMembership: true,
                    skipUpdatingEmotesets: true,
                },
                connection: {
                    reconnect: true,
                    secure: true
                },
                identity: {
                    username: 'Jiroshima_',  // Your bot's username
                    password: `oauth:${token}`  // Use the retrieved OAuth token here
                },
                channels: ['Jiroshima_']  // Channel to join
            });

            // Connect to Twitch chat
            client.connect().then(() => {
                console.log("Connected to Twitch chat!");
            }).catch((error) => {
                console.error("Connection failed:", error);
            });

            const chatContainer = document.getElementById('chat-container');

            client.on('message', (channel, tags, message, self) => {
                console.log(`Message received from ${tags.username}: ${message}`);

                if (self) return;  // Ignore messages from the bot itself

                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message');

                // **Filtering specific words for moderation**
                if (message.toLowerCase().includes("retard")) {
                    messageDiv.classList.add('filtered');
                    // Timeout for 30 seconds if the word "retard" is detected
                    timeoutUser(channel, tags.username, 30);
                } else if (message.toLowerCase().includes("superman")) {
                    messageDiv.classList.add('filtered');
                    // Ban user if 'superman' is detected
                    banUser(channel, tags.username, "Banned for 'superman'");
                } else if (message.toLowerCase().includes("batmobile")) {
                    messageDiv.classList.add('filtered');
                    // Timeout for 10 seconds if 'batmobile' is detected
                    timeoutUser(channel, tags.username, 10);
                }

                // Add the username and the message
                messageDiv.innerHTML = `<strong>${tags.username}:</strong> ${message}`;

                // Append the message div to the chat container
                chatContainer.appendChild(messageDiv);

                // Auto-scroll to the latest message
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // Timeout user via Twitch Helix API
        function timeoutUser(channel, username, duration) {
            fetch(`https://api.twitch.tv/helix/moderation/automod/timeout`, {
                method: 'POST',
                headers: {
                    'Client-ID': 'h29p7xsyql5d0bi8svypmjt3yqhl8z',
                    'Authorization': `Bearer ${localStorage.getItem('twitch_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    broadcaster_id: 'YOUR_BROADCASTER_ID',  // Replace with actual broadcaster ID
                    user_id: 'USER_ID_OF_' + username,  // Replace with actual user ID, you might need to look it up first
                    duration: duration * 60  // Duration in seconds
                })
            }).then(response => {
                if (response.ok) {
                    console.log(`User ${username} timed out for ${duration} seconds`);
                } else {
                    console.error("Failed to timeout user:", response);
                }
            }).catch(error => {
                console.error("Error timing out user:", error);
            });
        }

        // Ban user via Twitch Helix API
        function banUser(channel, username, reason) {
            fetch(`https://api.twitch.tv/helix/moderation/bans`, {
                method: 'POST',
                headers: {
                    'Client-ID': 'h29p7xsyql5d0bi8svypmjt3yqhl8z',
                    'Authorization': `Bearer ${localStorage.getItem('twitch_token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    broadcaster_id: 'YOUR_BROADCASTER_ID',  // Replace with actual broadcaster ID
                    user_id: 'USER_ID_OF_' + username,  // Replace with actual user ID
                    reason: reason
                })
            }).then(response => {
                if (response.ok) {
                    console.log(`User ${username} banned for reason: ${reason}`);
                } else {
                    console.error("Failed to ban user:", response);
                }
            }).catch(error => {
                console.error("Error banning user:", error);
            });
        }

        // Run the function when the page loads to retrieve the token
        window.onload = getTwitchToken;
    </script>
</body>

</html>
